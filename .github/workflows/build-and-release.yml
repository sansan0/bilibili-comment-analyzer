name: Release
permissions:
  contents: write
on:
  push:
    tags:
      - "v*"
jobs:
  build:
    name: æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry config virtualenvs.create false
          poetry install
      
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
      
      - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        env:
          PYTHONIOENCODING: utf-8
        run: poetry run cxfreeze build
      
      - name: åˆ›å»ºZIPå‹ç¼©åŒ…
        run: |
          # åˆ›å»ºè‹±æ–‡åæ–‡ä»¶å¤¹
          New-Item -ItemType Directory -Force -Path "bilibili-comment-analyzer_v${{ env.VERSION }}"
          # å¤åˆ¶æ„å»ºæ–‡ä»¶åˆ°æ–‡ä»¶å¤¹ä¸­
          Copy-Item -Path "build/exe.win-*/*" -Destination "bilibili-comment-analyzer_v${{ env.VERSION }}/" -Recurse
          # å‹ç¼©ä¸ºä¸­æ–‡åçš„zipæ–‡ä»¶
          Compress-Archive -Path "bilibili-comment-analyzer_v${{ env.VERSION }}" -DestinationPath "bilibili-comment-analyzer_v${{ env.VERSION }}_windows.zip"
      
      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: å“”å“©å“”å“©è¯„è®ºè§‚å¯Ÿè€… v${{ env.VERSION }}
          body: |
            ### ğŸ“¥ ä¸‹è½½ä½¿ç”¨
            
            ç‚¹å‡»ä¸‹æ–¹é™„ä»¶ä¸‹è½½åº”ç”¨ç¨‹åºï¼Œè§£å‹ååŒå‡»æ–‡ä»¶å¤¹å†…çš„ `å“”å“©å“”å“©è¯„è®ºè§‚å¯Ÿè€….exe` å³å¯è¿è¡Œã€‚
          draft: false
          prerelease: false
          files: |
            bilibili-comment-analyzer_v${{ env.VERSION }}_windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}